---
# Tasks to install and configure containerd

- name: Install Docker apt repo key + repo (Debian)
  when: ansible_facts['os_family'] == "Debian"
  block:
    - name: Install repo prerequisites
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Ensure apt keyrings dir exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Install Docker apt GPG key (dearmored keyring)
      ansible.builtin.shell: |
        curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod 0644 /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Remove any old docker repo list files (no signed-by)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/docker.list
        - /etc/apt/sources.list.d/docker-ce.list

    - name: Add Docker apt repository (signed-by)
      ansible.builtin.apt_repository:
        repo: >-
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
          https://download.docker.com/linux/debian
          {{ ansible_facts['distribution_release'] }} stable
        filename: docker
        state: present

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true


- name: Install containerd package
  ansible.builtin.package:
    name: containerd.io
    state: present

- name: Configure containerd
  ansible.builtin.copy:
    content: "{{ containerd_config }}"
    dest: "/etc/containerd/config.toml"
    force: true
    backup: true
  notify: restart containerd
