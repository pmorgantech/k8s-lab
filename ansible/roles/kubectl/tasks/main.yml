---
- name: Install kubectl
  tags: kubectl
  block:
    - name: Install prerequisites
      ansible.builtin.apt:
        name: [ca-certificates, curl, gnupg]
        state: present
        update_cache: true

    - name: Ensure apt keyrings dir exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Import apt repo GPG key
      ansible.builtin.include_role:
        name: apt_keyring
      vars:
        apt_keyring_url: "https://prod-cdn.packages.k8s.io/repositories/isv:/kubernetes:/core:/stable:/v{{ kubernetes_major_minor }}/deb/Release.key"
        apt_keyring_name: kubernetes-apt-keyring.gpg

    - name: Install kubectl
      ansible.builtin.apt:
        name: kubectl
        state: present
        update_cache: true
