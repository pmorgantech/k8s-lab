---
# Tasks to install and configure kubeadm

- name: Install Kubernetes apt repo key + repo (Debian)
  when: ansible_facts['os_family'] == "Debian"
  block:
    - name: Ensure apt keyrings dir exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Install Kubernetes apt GPG key (dearmored keyring)
      ansible.builtin.shell: |
        curl -fsSL "https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_major_minor }}/deb/Release.key" \
          | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        chmod 0644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Remove any old kubernetes repo list files (no signed-by)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/kubernetes.list
        - /etc/apt/sources.list.d/kubernetes*.list

    - name: Add Kubernetes apt repository (signed-by)
      ansible.builtin.apt_repository:
        repo: >-
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg]
          https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_major_minor }}/deb/ /
        filename: kubernetes
        state: present

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

- name: Install kubeadm packages
  ansible.builtin.package:
    name: "{{ kubernetes_packages }}"
    state: present
