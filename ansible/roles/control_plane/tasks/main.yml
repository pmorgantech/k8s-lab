---
# Tasks to initialize the Kubernetes control plane

# Needed for kubernetes.core.k8s module to interact with the cluster during
# control plane initialization (e.g. applying CNI manifests).
- name: Install python kubernetes support
  ansible.builtin.package:
    name: python3-kubernetes
    state: present

- name: Check if kubeadm has already initialized this node
  ansible.builtin.stat:
    path: /etc/kubernetes/admin.conf
  register: control_plane_kubeadm_initialized

- name: Initialize first control plane node
  when:
    - ansible_facts['hostname'] == groups['control_plane'][0]
    - not control_plane_kubeadm_initialized.stat.exists
  block:
    - name: Create config manifest
      ansible.builtin.copy:
        dest: /etc/kubernetes/kubeadm-init.yaml
        mode: '0600'
        owner: root
        group: root
        content: |
          ---
          apiVersion: kubeadm.k8s.io/v1beta4
          kind: ClusterConfiguration
          clusterName: "{{ cluster_name }}"
          controlPlaneEndpoint: "{{ control_plane_endpoint }}:6443"
          networking:
            podSubnet: "{{ pod_cidr }}"
          ---
          apiVersion: kubeadm.k8s.io/v1beta4
          kind: InitConfiguration
          nodeRegistration:
            criSocket: unix:///run/containerd/containerd.sock

    - name: Run kubeadm init command
      ansible.builtin.command: >
        kubeadm init
        --config /etc/kubernetes/kubeadm-init.yaml
        --upload-certs
      register: control_plane_kubeadm_init_result
      changed_when: true
      failed_when: false

- name: Create ~/.kube dir
  tags: copy_admin_conf
  ansible.builtin.file:
    path: "{{ (admin_user == 'root') | ternary('/root', '/home/' + admin_user) }}/.kube"
    state: directory
    mode: '0700'
    owner: "{{ admin_user }}"
  loop: "{{ admin_users }}"
  loop_control:
    loop_var: admin_user

- name: Copy admin.conf to all control plane nodes
  tags: copy_admin_conf
  ansible.builtin.fetch:
    src: /etc/kubernetes/admin.conf
    dest: /tmp/k8s-admin.conf
    mode: '0600'
    owner: root
    group: root
    flat: true
  run_once: true
  delegate_to: "{{ groups['control_plane'][0] }}"

- name: Copy admin.conf all control plane nodes
  tags: copy_admin_conf
  ansible.builtin.copy:
    src: /tmp/k8s-admin.conf
    dest: "{{ (admin_user == 'root') | ternary('/root', '/home/' + admin_user) }}/.kube/config"
    mode: '0600'
    owner: "{{ admin_user }}"
  loop: "{{ admin_users }}"
  loop_control:
    loop_var: admin_user

- name: Remove temporary admin.conf file
  tags: remove_admin_conf
  ansible.builtin.file:
    path: /tmp/k8s-admin.conf
    state: absent

- name: Generate and publish control-plane join command
  tags: [join_control_plane]
  delegate_to: "{{ groups['control_plane'][0] }}"
  run_once: true
  when:
    - is_ha_cluster | bool
    # The control_plane role is used in multiple plays (init on cp01, join on cp02+).
    # Generate/upload certs only during the join play, while delegating execution to
    # the first control plane node.
    - inventory_hostname != groups['control_plane'][0]
  block:
    - name: Create join command
      ansible.builtin.command: kubeadm token create --print-join-command
      register: control_plane_worker_join
      changed_when: false
      run_once: true
      delegate_to: "{{ groups['control_plane'][0] }}"

    - name: Upload certs and capture certificate key
      ansible.builtin.command: kubeadm init phase upload-certs --upload-certs
      register: control_plane_upload_certs
      changed_when: false

    # Do not complain about worker_join_command below
    # noqa: var-naming[no-role-prefix]
    - name: Save control_plane_join_command fact on first control_plane for other hosts to use
      ansible.builtin.set_fact:
        control_plane_join_command: >-
          {{ control_plane_worker_join.stdout }}
          --control-plane
          --certificate-key {{ control_plane_upload_certs.stdout_lines | last }}
        worker_join_command: "{{ control_plane_worker_join.stdout }}"
      delegate_facts: true
      changed_when: false

- name: Check if control-plane already joined
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: control_plane_kubelet_conf

- name: Join additional control plane nodes
  tags: [join_control_plane]
  ansible.builtin.command: "{{ hostvars[groups['control_plane'][0]].control_plane_join_command }}"
  when:
    - is_ha_cluster | bool
    - inventory_hostname != groups['control_plane'][0]
    - not control_plane_kubelet_conf.stat.exists
  changed_when: false
